<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Initiate Audit - KibbleScan</title>
    <link rel="stylesheet" href="style.css?v=3.0">
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script src="app.js?v=3.2" defer></script>
</head>

<body style="background:#F8FAFC;">
    <div class="device-container" style="margin-top:2rem; margin-bottom:2rem;">
        <div class="iphone-frame">
            <div class="screen-content">

                <!-- App Header -->
                <div class="app-header"
                    style="padding:16px 20px; background:white; border-bottom:1px solid #E2E8F0; display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-weight:800; font-size:1rem; color:#0F172A;">KibbleScan <span
                            style="font-size:0.6rem; color:#10B981; font-weight:700;">v4.6 (History)</span></div>
                    <div style="display:flex; gap:12px; align-items:center;">
                        <button id="btn-show-history"
                            style="background:none; border:none; color:#64748B; cursor:pointer; padding:4px;">
                            <ion-icon name="time-outline" style="font-size:1.4rem;"></ion-icon>
                        </button>
                    </div>
                </div>

                <!-- Main Scrollable Area -->
                <div id="app-viewport" style="flex:1; overflow-y:auto; padding:20px; scroll-behavior:smooth;">
                    <!-- ... -->
                </div>

                <!-- History Modal -->
                <div id="history-modal" class="modal-overlay hidden">
                    <div class="modal-panel">
                        <div class="modal-header">
                            <h3>Recent Scans</h3>
                            <button id="btn-close-history"><ion-icon name="close-outline"></ion-icon></button>
                        </div>
                        <div id="history-list" class="history-list-container">
                            <!-- Injected Items -->
                            <div style="text-align:center; padding:20px; color:#94A3B8;">Loading...</div>
                        </div>
                    </div>
                </div>

                <!-- Main Scrollable Area -->
                <div id="app-viewport" style="flex:1; overflow-y:auto; padding:20px; scroll-behavior:smooth;">

                    <!-- STATE 1: ENTRY -->
                    <div id="scan-entry">
                        <div style="text-align:center; margin-bottom:2rem; margin-top:1rem;">
                            <h1 style="font-size:1.5rem; margin-bottom:0.5rem; letter-spacing:-0.03em;">Initiate Audit.
                            </h1>
                            <p style="font-size:0.9rem; color:#64748B;">
                                Cross-reference inventory against the Global Toxicology Registry.
                            </p>
                        </div>

                        <button id="btn-camera-scan"
                            style="width:100%; background:white; border:2px dashed #CBD5E1; padding:2rem; border-radius:16px; cursor:pointer; transition:all 0.2s; text-align:center; color:#64748B; margin-bottom:1.5rem;">
                            <ion-icon name="camera-outline"
                                style="font-size:2.5rem; margin-bottom:0.5rem; color:#1E293B;"></ion-icon>
                            <div style="font-weight:600; color:#1E293B;">Scan Label</div>
                        </button>

                        <input type="file" id="file-upload-trigger" style="display:none;" accept="image/*"
                            capture="environment">

                        <input type="file" id="file-upload-trigger" style="display:none;" accept="image/*"
                            capture="environment">

                    </div>

                    <!-- STATE 2: PROCESSING (Hidden) -->
                    <div id="scan-processing" style="display:none; height:100%; padding-top:2rem; text-align:center;">
                        <h2 style="font-size:1.2rem; margin-bottom:2rem;">Processing Data...</h2>

                        <!-- Scanning Animation (Bio-Grid) -->
                        <div class="scan-container">
                            <div class="scan-grid"></div>
                            <div class="scan-beam"></div>
                            <div class="scan-overlay"></div>

                            <div
                                style="position:absolute; bottom:15px; left:20px; font-family:'Courier New', monospace; font-size:0.75rem; color:#22D3EE; z-index:20;">
                                <div class="typing-text">> BIO-METRIC ANALYSIS INITIATED...</div>
                                <div style="opacity:0.7; margin-top:2px;">> TARGET ACQUIRED</div>
                            </div>
                        </div>

                        <div id="cli-output"
                            style="font-family:'Courier New', monospace; font-size:0.8rem; color:#64748B; text-align:left; min-height:60px;">
                            <span>> Initializing Secure Handshake...</span>
                        </div>
                    </div>

                    <!-- STATE 3: RESULT (Hidden) -->
                    <div id="scan-result" style="display:none;">
                        <button id="btn-reset" onclick="location.reload()"
                            style="background:none; border:none; color:#64748B; font-size:0.85rem; margin-bottom:1rem; cursor:pointer; padding:0;">‚Üê
                            New Audit</button>

                        <div id="result-header"
                            style="background:white; border-radius:16px; padding:20px; box-shadow:0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom:1.5rem; text-align:center;">
                            <h2 id="result-verdict" style="font-size:1.8rem; font-weight:800; margin:0 0 8px 0;">VERDICT
                            </h2>
                            <p id="result-subtext" style="margin:0; font-size:0.9rem;">Analysis Complete.</p>

                            <!-- Stamp -->
                            <div id="result-stamp"
                                style="margin:16px auto 0 auto; width:60px; height:60px; border:3px solid; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:0.7rem; transform:rotate(-15deg); opacity:0.3;">
                                AUDIT
                            </div>
                        </div>

                        <div
                            style="font-size:0.75rem; text-transform:uppercase; color:#94A3B8; margin-bottom:0.8rem; font-weight:700;">
                            Full Findings</div>
                        <div id="result-findings"
                            style="background:white; border-radius:12px; overflow:hidden; border:1px solid #E2E8F0;">
                            <!-- Injected Content -->
                        </div>

                        <button onclick="location.reload()" class="btn-primary"
                            style="width:100%; margin-top:2rem; justify-content:center;">Finish Audit</button>
                    </div>

                    <!-- STATE 4: ERROR / UNKNOWN (Simplified) -->
                    <div id="scan-error" style="display:none; text-align:center; padding-top:4rem;">
                        <ion-icon name="alert-circle"
                            style="font-size:3rem; color:#EF4444; margin-bottom:1rem;"></ion-icon>
                        <h3>Scan Failed</h3>
                        <button onclick="location.reload()" class="btn-primary" style="margin-top:1rem;">Try
                            Again</button>
                        <p id="error-details"
                            style="font-size:0.7rem; color:#EF4444; margin-top:10px; font-family:monospace;"></p>

                        <div
                            style="margin-top: 2rem; text-align: left; background: #FEF08A; padding: 10px; border-radius: 8px; font-size: 0.75rem; border: 2px solid #EAB308;">
                            <strong style="display:block; margin-bottom:5px; color:#475569;">Debug Info (Tap to
                                Copy):</strong>
                            <div id="debug-error-text"
                                style="white-space: pre-wrap; word-break: break-word; color:#334155; max-height: 100px; overflow-y: auto; user-select: text;">
                                Waiting for data...
                            </div>
                        </div>
                    </div>

                    <div id="scan-unknown" style="display:none; text-align:center; padding-top:4rem;">
                        <ion-icon name="help-circle-outline" style="font-size:4rem; color:#94A3B8;"></ion-icon>
                        <h3>Analysis Inconclusive</h3>
                        <p style="color:#64748B; margin-bottom:1.5rem;">Could not identify ingredients list.<br>Ensure
                            text is clear and well-lit.</p>
                        <button onclick="location.reload()" class="btn-primary">Try Again</button>

                        <div
                            style="margin-top: 2rem; text-align: left; background: #FEF08A; padding: 10px; border-radius: 8px; font-size: 0.75rem; border: 2px solid #EAB308;">
                            <strong style="display:block; margin-bottom:5px; color:#475569;">Debug Info (Tap to
                                Copy):</strong>
                            <div id="debug-raw-text"
                                style="white-space: pre-wrap; word-break: break-word; color:#334155; max-height: 100px; overflow-y: auto; user-select: text;">
                                Waiting for data...
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Home Indicator -->
                <div style="height:20px; display:flex; justify-content:center; align-items:center;">
                    <div style="width:120px; height:4px; background:#CBD5E1; border-radius:2px;"></div>
                </div>

            </div>
        </div>
    </div>

    <!-- Paddle.js -->
    <script src="https://cdn.paddle.com/paddle/v2/paddle.js"></script>
    <script>
        Paddle.Initialize({
            token: "test_8772b40c927a726a3190b415cd9",
            environment: "sandbox"
        });
    </script>

    <script>
        function maybeShowMonitoringModal(user) {
            if (!user || !user.isMonitoringActive) {
                const modal = document.getElementById("monitoringModal");
                if (modal) modal.classList.remove("hidden");
            }
        }

        function openMonitoringModal() {
            const modal = document.getElementById("monitoringModal");
            if (modal) modal.classList.remove("hidden");
        }

        const closeBtn = document.getElementById("closeMonitoringModal");
        if (closeBtn) {
            closeBtn.addEventListener("click", function (e) {
                e.preventDefault();
                const modal = document.getElementById("monitoringModal");
                if (modal) modal.classList.add("hidden");
            });
        }

        const enableBtn = document.getElementById("enableMonitoringBtn");
        if (enableBtn) {
            enableBtn.addEventListener("click", function () {
                // Paddle Checkout
                Paddle.Checkout.open({
                    items: [{
                        priceId: 'pri_01khcchknvqv3w3dc9r2c5jpwj', // Monitoring Plan ($6)
                        quantity: 1
                    }],
                    settings: {
                        successUrl: window.location.origin + '/success.html',
                        displayMode: 'overlay',
                        theme: 'light'
                    }
                });
            });
        }
    </script>
</body>

</html>