<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Initiate Audit - KibbleScan</title>
    <link rel="stylesheet" href="style.css">
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script src="app.js?v=3.1" defer></script>
</head>

<body style="background:#F8FAFC;">
    <div class="device-container" style="margin-top:2rem; margin-bottom:2rem;">
        <div class="iphone-frame"
            style="max-width:400px; margin:0 auto; background:#1e293b; padding:12px; border-radius:40px; box-shadow:0 20px 40px -10px rgba(0,0,0,0.5);">
            <div class="screen-content"
                style="background:#F8FAFC; border-radius:30px; overflow:hidden; height:750px; position:relative; display:flex; flex-direction:column;">

                <!-- App Header -->
                <div class="app-header"
                    style="padding:16px 20px; background:white; border-bottom:1px solid #E2E8F0; display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-weight:800; font-size:1rem; color:#0F172A;">KibbleScan <span
                            style="font-size:0.6rem; color:#EAB308; font-weight:700;">v3.2 (YELLOW BOX)</span></div>
                    <div style="display:flex; gap:4px;">
                        <span style="width:6px; height:6px; background:#10B981; border-radius:50%;"></span>
                    </div>
                </div>

                <!-- Main Scrollable Area -->
                <div id="app-viewport" style="flex:1; overflow-y:auto; padding:20px; scroll-behavior:smooth;">

                    <!-- STATE 1: ENTRY -->
                    <div id="scan-entry">
                        <div style="text-align:center; margin-bottom:2rem; margin-top:1rem;">
                            <h1 style="font-size:1.5rem; margin-bottom:0.5rem; letter-spacing:-0.03em;">Initiate Audit.
                            </h1>
                            <p style="font-size:0.9rem; color:#64748B;">
                                Cross-reference inventory against the Global Toxicology Registry.
                            </p>
                        </div>

                        <button id="btn-camera-scan"
                            style="width:100%; background:white; border:2px dashed #CBD5E1; padding:2rem; border-radius:16px; cursor:pointer; transition:all 0.2s; text-align:center; color:#64748B; margin-bottom:1.5rem;">
                            <ion-icon name="camera-outline"
                                style="font-size:2.5rem; margin-bottom:0.5rem; color:#1E293B;"></ion-icon>
                            <div style="font-weight:600; color:#1E293B;">Scan Label</div>
                        </button>

                        <input type="file" id="file-upload-trigger" style="display:none;" accept="image/*"
                            capture="environment">

                        <div style="text-align:center; margin-top:2rem;">
                            <div
                                style="font-size:0.75rem; text-transform:uppercase; color:#94A3B8; margin-bottom:1rem;">
                                Recent Activity</div>
                            <div
                                style="background:white; padding:12px; border-radius:8px; border:1px solid #E2E8F0; font-size:0.8rem; text-align:left; color:#64748B;">
                                <div style="margin-bottom:4px; display:flex; justify-content:space-between;">
                                    <span>Scan #8821</span>
                                    <span style="color:#10B981; font-weight:600;">VERIFIED</span>
                                </div>
                                <div style="display:flex; justify-content:space-between;">
                                    <span>Scan #8820</span>
                                    <span style="color:#EF4444; font-weight:600;">FLAGGED</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- STATE 2: PROCESSING (Hidden) -->
                    <div id="scan-processing" style="display:none; height:100%; padding-top:2rem; text-align:center;">
                        <h2 style="font-size:1.2rem; margin-bottom:2rem;">Processing Data...</h2>

                        <!-- Scanning Animation -->
                        <div
                            style="position:relative; width:100%; height:200px; background:#1E293B; border-radius:12px; margin-bottom:2rem; overflow:hidden;">
                            <div
                                style="position:absolute; top:0; left:0; right:0; height:2px; background:#22D3EE; box-shadow:0 0 10px #22D3EE; animation:scan-line 1.5s infinite ease-in-out;">
                            </div>
                            <div
                                style="padding:20px; color:#475569; font-family:'Courier New'; font-size:0.8rem; text-align:left;">
                                > Ingesting Image...<br>
                                > Optical Char Rec...<br>
                                > Quantizing...
                            </div>
                        </div>

                        <div id="cli-output"
                            style="font-family:'Courier New', monospace; font-size:0.8rem; color:#64748B; text-align:left; min-height:60px;">
                            <span>> Initializing Secure Handshake...</span>
                        </div>
                    </div>

                    <!-- STATE 3: RESULT (Hidden) -->
                    <div id="scan-result" style="display:none;">
                        <button id="btn-reset" onclick="location.reload()"
                            style="background:none; border:none; color:#64748B; font-size:0.85rem; margin-bottom:1rem; cursor:pointer; padding:0;">‚Üê
                            New Audit</button>

                        <div id="result-header"
                            style="background:white; border-radius:16px; padding:20px; box-shadow:0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom:1.5rem; text-align:center;">
                            <h2 id="result-verdict" style="font-size:1.8rem; font-weight:800; margin:0 0 8px 0;">VERDICT
                            </h2>
                            <p id="result-subtext" style="margin:0; font-size:0.9rem;">Analysis Complete.</p>

                            <!-- Stamp -->
                            <div id="result-stamp"
                                style="margin:16px auto 0 auto; width:60px; height:60px; border:3px solid; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:0.7rem; transform:rotate(-15deg); opacity:0.3;">
                                AUDIT
                            </div>
                        </div>

                        <div
                            style="font-size:0.75rem; text-transform:uppercase; color:#94A3B8; margin-bottom:0.8rem; font-weight:700;">
                            Full Findings</div>
                        <div id="result-findings"
                            style="background:white; border-radius:12px; overflow:hidden; border:1px solid #E2E8F0;">
                            <!-- Injected Content -->
                        </div>

                        <button onclick="location.reload()" class="btn-primary"
                            style="width:100%; margin-top:2rem; justify-content:center;">Finish Audit</button>
                    </div>

                    <!-- STATE 4: ERROR / UNKNOWN (Simplified) -->
                    <div id="scan-error" style="display:none; text-align:center; padding-top:4rem;">
                        <ion-icon name="alert-circle"
                            style="font-size:3rem; color:#EF4444; margin-bottom:1rem;"></ion-icon>
                        <h3>Scan Failed</h3>
                        <button onclick="location.reload()" class="btn-primary" style="margin-top:1rem;">Try
                            Again</button>
                        <p id="error-details"
                            style="font-size:0.7rem; color:#EF4444; margin-top:10px; font-family:monospace;"></p>

                        <div
                            style="margin-top: 2rem; text-align: left; background: #FEF08A; padding: 10px; border-radius: 8px; font-size: 0.75rem; border: 2px solid #EAB308;">
                            <strong style="display:block; margin-bottom:5px; color:#475569;">Debug Info (Tap to
                                Copy):</strong>
                            <div id="debug-error-text"
                                style="white-space: pre-wrap; word-break: break-word; color:#334155; max-height: 100px; overflow-y: auto; user-select: text;">
                                Waiting for data...
                            </div>
                        </div>
                    </div>

                    <div id="scan-unknown" style="display:none; text-align:center; padding-top:4rem;">
                        <ion-icon name="help-circle-outline" style="font-size:4rem; color:#94A3B8;"></ion-icon>
                        <h3>Analysis Inconclusive</h3>
                        <p style="color:#64748B; margin-bottom:1.5rem;">Could not identify ingredients list.<br>Ensure
                            text is clear and well-lit.</p>
                        <button onclick="location.reload()" class="btn-primary">Try Again</button>

                        <div
                            style="margin-top: 2rem; text-align: left; background: #FEF08A; padding: 10px; border-radius: 8px; font-size: 0.75rem; border: 2px solid #EAB308;">
                            <strong style="display:block; margin-bottom:5px; color:#475569;">Debug Info (Tap to
                                Copy):</strong>
                            <div id="debug-raw-text"
                                style="white-space: pre-wrap; word-break: break-word; color:#334155; max-height: 100px; overflow-y: auto; user-select: text;">
                                Waiting for data...
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Home Indicator -->
                <div style="height:20px; display:flex; justify-content:center; align-items:center;">
                    <div style="width:120px; height:4px; background:#CBD5E1; border-radius:2px;"></div>
                </div>

            </div>
        </div>
    </div>

    <!-- Paddle.js -->
    <script src="https://cdn.paddle.com/paddle/v2/paddle.js"></script>
    <script>
        Paddle.Initialize({
            token: "test_8772b40c927a726a3190b415cd9",
            environment: "sandbox"
        });
    </script>

    <script>
        function maybeShowMonitoringModal(user) {
            if (!user || !user.isMonitoringActive) {
                const modal = document.getElementById("monitoringModal");
                if (modal) modal.classList.remove("hidden");
            }
        }

        function openMonitoringModal() {
            const modal = document.getElementById("monitoringModal");
            if (modal) modal.classList.remove("hidden");
        }

        const closeBtn = document.getElementById("closeMonitoringModal");
        if (closeBtn) {
            closeBtn.addEventListener("click", function (e) {
                e.preventDefault();
                const modal = document.getElementById("monitoringModal");
                if (modal) modal.classList.add("hidden");
            });
        }

        const enableBtn = document.getElementById("enableMonitoringBtn");
        if (enableBtn) {
            enableBtn.addEventListener("click", function () {
                // Paddle Checkout
                Paddle.Checkout.open({
                    items: [{
                        priceId: 'pri_01khcchknvqv3w3dc9r2c5jpwj', // Monitoring Plan ($6)
                        quantity: 1
                    }],
                    settings: {
                        successUrl: window.location.origin + '/success.html',
                        displayMode: 'overlay',
                        theme: 'light'
                    }
                });
            });
        }
    </script>
</body>

</html>